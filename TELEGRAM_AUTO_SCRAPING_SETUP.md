# Automatic Telegram News Scraping - Setup Guide

## Why Telegram User API (Not Bot API)?

### The Problem with Bot API
- **âŒ Cannot read public channels** unless the bot is an admin
- **âŒ Official news channels** (BBC Persian, Manoto, etc.) will never grant admin access to random bots
- **âŒ Manual forwarding** is not scalable for a news aggregator

### The Solution: Telegram User API
- **âœ… Reads ANY public channel** without needing admin access
- **âœ… Acts like a real Telegram user** (because it is!)
- **âœ… Fully automatic** - no manual forwarding required
- **âœ… Access to message history** - can scrape past messages
- **âœ… Real-time updates** - receive new messages instantly

---

## How It Works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Persian News Channels              â”‚
â”‚  - @BBCPersian                      â”‚
â”‚  - @manoto_tv                       â”‚
â”‚  - @IranIntlTV                      â”‚
â”‚  - @RadioFarda                      â”‚
â”‚  - @VOAFarsi                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“ (public posts)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram User API Client           â”‚
â”‚  - Monitors channels 24/7           â”‚
â”‚  - Filters by keywords              â”‚
â”‚  - Extracts article data            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“ (filtered articles)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  News Aggregator API                â”‚
â”‚  - Deduplicates articles            â”‚
â”‚  - Saves to Firestore               â”‚
â”‚  - Sends push notifications         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Setup Steps

### 1. Create Telegram Application

1. Go to https://my.telegram.org/apps
2. Log in with your phone number
3. Click **"API development tools"**
4. Fill in the form:
   - **App title**: Persian Uprising News Aggregator
   - **Short name**: uprising-news
   - **Platform**: Other
   - **Description**: Automated news aggregator for Persian uprising
5. Click **"Create application"**
6. Save your `api_id` and `api_hash`

### 2. Add Credentials to Environment

Add to `.env`:

```bash
# Telegram User API (from https://my.telegram.org/apps)
TELEGRAM_API_ID=12345678
TELEGRAM_API_HASH=abcdef1234567890abcdef1234567890

# Session string (generated by setup script - leave empty for now)
TELEGRAM_SESSION_STRING=
```

### 3. Run Authentication Script

This is a **one-time setup** to authenticate your account:

```bash
npx tsx scripts/setup-telegram-user-api.ts
```

The script will:
1. Ask for your phone number (e.g., `+14155551234`)
2. Send a verification code to your Telegram app
3. Ask you to enter the code
4. If you have 2FA enabled, ask for your password
5. Generate a session string and save it to `.env`

**Example session:**

```
ğŸ” Telegram User API Setup

âœ… Found Telegram API credentials
   API ID: 12345678
   API Hash: abcdef1234...

ğŸ“± Connecting to Telegram...

Enter your phone number (with country code, e.g., +1234567890): +14155551234
Enter the verification code sent to your Telegram app: 12345
Enter your 2FA password (if enabled): ********

âœ… Successfully authenticated!
âœ… Session string saved to .env
```

### 4. Test the Scraper

```bash
npx tsx scripts/test-telegram-scraper.ts
```

Expected output:

```
ğŸ§ª Testing Telegram User API scraper

1ï¸âƒ£ Connecting to Telegram...
âœ… Connected to Telegram User API

2ï¸âƒ£ Fetching recent messages from Persian news channels...
âœ… Fetched 12 messages from @BBCPersian
âœ… Fetched 8 messages from @manoto_tv
âœ… Fetched 15 messages from @IranIntlTV

âœ… Found 35 uprising-related articles

ğŸ“° Article 1:
   Channel: BBC Persian (@BBCPersian)
   Title: Ø§Ø¹ØªØ±Ø§Ø¶Ø§Øª Ø¯Ø± ØªÙ‡Ø±Ø§Ù† Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø±Ø¯
   Summary: Ù‡Ø²Ø§Ø±Ø§Ù† Ù†ÙØ± Ø¯Ø± Ù…ÛŒØ¯Ø§Ù† Ø¢Ø²Ø§Ø¯ÛŒ ØªÙ‡Ø±Ø§Ù† ØªØ¬Ù…Ø¹ Ú©Ø±Ø¯Ù†Ø¯...
   URL: https://t.me/BBCPersian/12345
   Published: 1/12/2026, 3:45:00 PM
```

### 5. Deploy to Production

Add the session string to Vercel:

```bash
# Copy session string from .env
cat .env | grep TELEGRAM_SESSION_STRING

# Add to Vercel
vercel env add TELEGRAM_SESSION_STRING production
# Paste the session string when prompted

# Also add API credentials
vercel env add TELEGRAM_API_ID production
# Enter your API ID

vercel env add TELEGRAM_API_HASH production
# Enter your API hash
```

### 6. Update News API Endpoint

The `/api/news` endpoint will automatically use the Telegram scraper when the environment variables are set.

---

## How the Scraper Works

### Keyword Filtering

The scraper only fetches messages containing uprising-related keywords:

**Farsi Keywords:**
- Ø§Ø¹ØªØ±Ø§Ø¶ (Protest)
- ØªØ¸Ø§Ù‡Ø±Ø§Øª (Demonstration)
- Ù…Ù‡Ø³Ø§ Ø§Ù…ÛŒÙ†ÛŒ (Mahsa Amini)
- Ø²Ù† Ø²Ù†Ø¯Ú¯ÛŒ Ø¢Ø²Ø§Ø¯ÛŒ (Woman Life Freedom)

**English Keywords:**
- protest
- demonstration
- uprising
- iran protests
- mahsa amini
- woman life freedom

### Monitored Channels

```typescript
const MONITORED_CHANNELS = [
  '@BBCPersian',         // BBC Persian - most reliable source
  '@manoto_tv',          // Manoto TV - popular Persian channel
  '@IranIntlTV',         // Iran International - UK-based news
  '@RadioFarda',         // Radio Farda - US-funded news
  '@VOAFarsi',           // Voice of America Farsi
  '@persianvoa',         // VOA Persian (alternative)
  '@iran_intl_fa',       // Iran International (Farsi)
];
```

To add more channels, edit `lib/telegram-user-api.ts` line 18.

### Real-Time vs Polling

**Polling Mode** (safer for serverless):
- Fetch last 24 hours of messages every 10 minutes
- Uses `/api/cron/scrape` endpoint
- No persistent connection needed

**Real-Time Mode** (requires long-running process):
- Listen for new messages instantly
- Uses WebSocket connection to Telegram
- Better for local development or VPS deployment

---

## Production Deployment

### Option 1: Vercel Cron Jobs (Recommended)

Already configured in `vercel.json`:

```json
{
  "crons": [{
    "path": "/api/cron/scrape",
    "schedule": "*/10 * * * *"
  }]
}
```

This runs the scraper every 10 minutes automatically.

### Option 2: AWS Lambda

Create a Lambda function that runs every 10 minutes:

```yaml
# template.yaml
ScraperFunction:
  Type: AWS::Serverless::Function
  Properties:
    CodeUri: lambda/scraper/
    Handler: telegram-scraper.handler
    Runtime: nodejs20.x
    Environment:
      Variables:
        TELEGRAM_API_ID: !Ref TelegramApiId
        TELEGRAM_API_HASH: !Ref TelegramApiHash
        TELEGRAM_SESSION_STRING: !Ref TelegramSessionString
    Events:
      ScheduledScrape:
        Type: Schedule
        Properties:
          Schedule: rate(10 minutes)
```

---

## Troubleshooting

### Error: "Phone number required for first-time authentication"

**Solution**: Run `setup-telegram-user-api.ts` first to authenticate.

### Error: "TELEGRAM_SESSION_STRING not found"

**Solution**: Check that `.env` has the session string from setup script.

### Error: "Could not find the input entity"

**Cause**: Channel username is wrong or channel doesn't exist.

**Solution**: Verify channel exists by visiting `https://t.me/BBCPersian` in browser.

### No articles found

**Possible causes:**
1. No recent messages match the keywords
2. Channels have been inactive for 24 hours
3. Keyword list is too restrictive

**Solution**:
- Lower `hoursAgo` parameter to fetch more history
- Add more keywords to `UPRISING_KEYWORDS` array
- Check channels manually to see if they have content

### Session expired

**Cause**: Telegram sessions can expire after ~1 year or if you log out from that session.

**Solution**: Re-run `setup-telegram-user-api.ts` to generate a new session string.

---

## Security Considerations

### Is this legal?

**Yes!** You're using Telegram's official User API (MTProto) to read public channels. This is:
- âœ… Explicitly allowed by Telegram's terms of service
- âœ… Same API used by Telegram Desktop, Telegram Web, etc.
- âœ… Public channels are meant to be read by anyone

### Protecting your session string

**Important**: The session string is like a password for your Telegram account.

**Do NOT**:
- âŒ Commit session string to Git
- âŒ Share session string publicly
- âŒ Use your personal Telegram account (create a new one)

**Do**:
- âœ… Store session string in environment variables
- âœ… Encrypt session string at rest
- âœ… Use a dedicated Telegram account for scraping
- âœ… Enable 2FA on that account

### Rate Limits

Telegram has rate limits for User API:

- **~30 requests/second** per account
- **Flood wait** if exceeded (temporary ban for 30-60 seconds)

Our scraper is well within limits:
- Fetches 50 messages per channel every 10 minutes
- 7 channels Ã— 50 messages = 350 messages/10 minutes = ~0.6 requests/second

---

## Cost Comparison

| Solution | Monthly Cost | Pros | Cons |
|----------|--------------|------|------|
| **Telegram User API** | **$0** | Free, reliable, real-time | Requires phone number |
| Telegram Bot API (manual forward) | $0 | Official, simple | Not automatic, not scalable |
| Third-party scraping APIs | $50-200 | No phone needed | Expensive, may violate ToS |
| Running own Telegram client | $5 (VPS) | Full control | Requires server management |

---

## Migration from Bot API

If you already set up the bot, you can keep it running alongside the User API:

1. User API fetches from official channels (BBC Persian, etc.)
2. Bot API receives crowdsourced reports from users

This hybrid approach gives you:
- âœ… Automatic aggregation from official sources
- âœ… Crowdsourced reports from community
- âœ… Best of both worlds

---

## Next Steps

1. âœ… Run setup script to authenticate
2. âœ… Test with `test-telegram-scraper.ts`
3. âœ… Integrate with `/api/news` endpoint
4. âœ… Deploy to Vercel with environment variables
5. âœ… Monitor first scrape to verify it works
6. âœ… Add more channels as needed

---

**Need help?** Check Telegram's official MTProto docs:
https://core.telegram.org/mtproto

**Library documentation:**
https://gram.js.org/
